# 代码管理功能实现说明

## 功能概述

在自动化管理界面中新增了"代码管理"功能，允许用户直接编辑自动化项目的Python测试代码，实现代码的实时编辑、保存和执行。

## 功能特性

### 1. 代码管理按钮
- 位置：在自动化管理界面的编辑按钮后面
- 图标：代码图标（fas fa-code）
- 功能：点击后打开代码编辑弹窗

### 2. 代码编辑弹窗
- **弹窗大小**：超大尺寸（90%宽度，85%高度）
- **编辑器风格**：VS Code风格的深色主题
- **语法支持**：Python语法高亮
- **功能按钮**：
  - 重置：恢复原始代码
  - 保存：保存当前代码
  - 取消：关闭弹窗

### 3. 代码编辑器功能
- **实时统计**：显示代码行数和字符数
- **状态显示**：显示当前编辑状态（就绪、已修改、保存中、已保存等）
- **Tab键支持**：自动插入4个空格
- **滚动条**：自定义滚动条样式
- **响应式设计**：支持移动设备

### 4. 文件管理
- **自动生成文件名**：基于产品ID生成`test_{product_id}.py`格式
- **文件路径**：保存在`Test_Case/`目录下
- **编码支持**：UTF-8编码，支持中文注释

## 技术实现

### 前端实现

#### 1. HTML结构
```html
<!-- 代码管理弹窗 -->
<div id="codeManagementModal" class="modal">
    <div class="modal-content extra-large">
        <div class="modal-header">
            <h2 id="code-modal-title">代码管理</h2>
            <span class="close" onclick="automationManagement.closeCodeManagementModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="code-editor-container">
                <!-- 编辑器头部 -->
                <div class="code-editor-header">
                    <div class="file-info">
                        <i class="fas fa-file-code"></i>
                        <span id="code-file-name">test_file.py</span>
                    </div>
                    <div class="code-actions">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="automationManagement.resetCode()">
                            <i class="fas fa-undo"></i>
                            重置
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" onclick="automationManagement.saveCode()">
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                    </div>
                </div>
                <!-- 代码编辑器 -->
                <div class="code-editor-wrapper">
                    <textarea id="codeEditor" class="code-editor" placeholder="代码编辑器加载中..."></textarea>
                </div>
                <!-- 编辑器底部 -->
                <div class="code-editor-footer">
                    <div class="code-status">
                        <span id="code-status-text">就绪</span>
                    </div>
                    <div class="code-info">
                        <span id="code-line-count">0 行</span>
                        <span id="code-char-count">0 字符</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="automationManagement.closeCodeManagementModal()">取消</button>
            <button type="button" class="btn btn-success" onclick="automationManagement.saveCode()">
                <i class="fas fa-save"></i>
                保存代码
            </button>
        </div>
    </div>
</div>
```

#### 2. CSS样式
- **深色主题**：VS Code风格的深色背景
- **代码字体**：等宽字体（Consolas, Monaco, Courier New）
- **语法高亮**：Python语法颜色
- **自定义滚动条**：深色主题滚动条
- **响应式布局**：支持不同屏幕尺寸

#### 3. JavaScript功能
```javascript
// 主要方法
- openCodeManagement(projectId)     // 打开代码管理
- closeCodeManagementModal()        // 关闭代码管理
- loadProjectCode(projectId)        // 加载项目代码
- saveCode()                       // 保存文件
- resetCode()                      // 重置代码
- initCodeEditor()                 // 初始化编辑器
- updateCodeStatus(status)         // 更新状态
- updateCodeInfo()                 // 更新统计信息
```

### 后端实现

#### 1. API接口

**获取代码接口**
```
GET /api/automation/projects/{project_id}/code
```
- 功能：获取项目的代码内容
- 返回：代码内容、文件名、项目名称

**保存文件接口**
```
POST /api/automation/projects/{project_id}/code
```
- 功能：保存项目的代码内容
- 参数：JSON格式的代码内容
- 返回：保存结果、文件路径

#### 2. 文件管理
- **文件名生成**：基于产品ID自动生成
- **目录结构**：保存在`Test_Case/`目录
- **编码处理**：UTF-8编码支持
- **错误处理**：文件不存在时生成默认代码

#### 3. 执行集成
- **文件名统一**：代码管理和执行使用相同的文件名格式
- **实时更新**：保存后立即生效
- **执行验证**：确保使用最新的代码文件

## 使用流程

### 1. 打开代码管理
1. 进入自动化管理页面
2. 找到目标项目
3. 点击"代码管理"按钮
4. 弹窗打开，自动加载项目代码

### 2. 编辑代码
1. 在代码编辑器中修改代码
2. 实时查看行数和字符数统计
3. 使用Tab键进行缩进
4. 查看编辑状态变化

### 3. 保存代码
1. 点击"保存"按钮或"保存文件"按钮
2. 系统将代码保存到对应的.py文件
3. 显示保存成功提示
4. 状态更新为"已保存"

### 4. 执行测试
1. 保存代码后，点击"执行测试"
2. 系统使用最新的代码文件执行测试
3. 实时查看执行状态和结果

## 默认代码模板

当项目没有现有代码文件时，系统会生成以下默认模板：

```python
import time
import pyautogui
import numpy
from conftest import *
from Base_Page.Base_Pages import BasePage
from Base_ENV.config import *

def test_{product_id}(browser, **elem):
    pages = browser.new_page()
    base_page = BasePage(pages)
    
    # 配置参数
    website_url = "{product_address}"
    
    # 导航到目标网站
    base_page.goto(website_url)
    
    # 初始检查浏览器状态
    if base_page.is_browser_closed():
        print("检测到浏览器已关闭，测试无法继续")
        raise Exception("BROWSER_CLOSED_BY_USER")
    
    # 在这里添加您的测试步骤
    # 示例：
    # time.sleep(1)
    # base_page.elem_click("//button[text()='开始']")
    
    print("测试完成")
```

## 错误处理

### 1. 加载失败
- 显示错误信息在编辑器中
- 提供友好的错误提示
- 记录详细的错误日志

### 2. 保存失败
- 显示具体的错误原因
- 保持编辑器内容不变
- 提供重试选项

### 3. 文件权限问题
- 检查目录权限
- 自动创建必要目录
- 提供权限修复建议

## 安全考虑

### 1. 代码验证
- 检查代码语法
- 防止恶意代码注入
- 限制文件大小

### 2. 权限控制
- 用户身份验证
- 项目访问权限
- 操作日志记录

### 3. 数据备份
- 保存前备份原文件
- 版本控制支持
- 恢复机制

## 性能优化

### 1. 编辑器优化
- 延迟加载大文件
- 虚拟滚动支持
- 内存使用优化

### 2. 网络优化
- 压缩传输数据
- 缓存机制
- 断点续传

### 3. 用户体验
- 加载状态提示
- 操作反馈及时
- 错误信息友好

## 扩展功能

### 1. 代码高亮
- 支持更多编程语言
- 自定义主题
- 语法检查

### 2. 版本管理
- Git集成
- 版本历史
- 差异对比

### 3. 协作功能
- 多人编辑
- 实时同步
- 冲突解决

## 总结

代码管理功能的实现为自动化测试平台提供了强大的代码编辑能力，用户可以直接在Web界面中编辑、保存和执行Python测试代码，大大提升了开发效率和用户体验。该功能采用现代化的设计理念，具有良好的可扩展性和维护性。 
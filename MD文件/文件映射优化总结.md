# 文件映射优化总结

## 优化背景

### 原有问题
1. **文件命名混乱**：使用项目ID作为文件名的一部分，导致文件名冗长且不直观
2. **映射关系不明确**：项目ID和文件名之间缺乏明确的映射关系
3. **编辑冲突**：编辑保存和代码管理可能操作不同的文件
4. **扩展性差**：后续项目增多时，文件管理变得困难

### 优化目标
- 实现简洁的文件命名：`{product_id}_{system}_test.py`、`{product_id}_{system}_2_test.py` 等
- 建立精确的项目文件映射关系
- 确保所有操作都基于正确的文件
- 提高系统的可维护性和扩展性

## 优化方案

### 1. 文件命名优化

#### 新的命名规则
- **基础格式**：`{clean_product_id}_{system}_test.py`
- **重复处理**：如果文件已存在，自动添加序号：`{clean_product_id}_{system}_2_test.py`
- **示例**：
  - 第一个SC Web项目：`SC_Web_test.py`
  - 第二个SC Web项目：`SC_Web_2_test.py`
  - 第三个SC Web项目：`SC_Web_3_test.py`

#### 实现方法
```python
def _generate_unique_filename(self, base_file_name: str) -> str:
    """生成唯一的文件名"""
    # 如果基础文件名不存在，直接返回
    file_path = os.path.join(self.test_case_dir, base_file_name)
    if not os.path.exists(file_path):
        return base_file_name
    
    # 如果文件存在，查找下一个可用的序号
    name_without_ext = base_file_name.replace('.py', '')
    counter = 2
    
    while True:
        new_file_name = f"{name_without_ext}_{counter}.py"
        new_file_path = os.path.join(self.test_case_dir, new_file_name)
        
        if not os.path.exists(new_file_path):
            return new_file_name
        
        counter += 1
```

### 2. 数据库映射优化

#### 项目文件映射表
```sql
CREATE TABLE project_files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    project_id INTEGER NOT NULL,
    project_name TEXT NOT NULL,
    file_name TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_type TEXT DEFAULT 'py',
    is_active BOOLEAN DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES automation_projects (id) ON DELETE CASCADE,
    UNIQUE(project_id, file_name)
)
```

#### 映射关系示例
| 项目ID | 项目名称 | 文件名 | 文件路径 |
|--------|----------|--------|----------|
| 2 | MoonlitWolf-进入游戏 | SC_Web_test.py | Test_Case/SC_Web_test.py |
| 3 | MoonlitWolf-进入游戏2 | SC_Web_2_test.py | Test_Case/SC_Web_2_test.py |
| 4 | MoonlitWolf-进入游戏3 | SC_Web_3_test.py | Test_Case/SC_Web_3_test.py |

### 3. 核心功能优化

#### 新建项目流程
1. **前端保存项目** → 调用 `create_automation_project()`
2. **创建项目记录** → 插入 `automation_projects` 表
3. **生成文件映射** → 调用 `file_manager.create_project_file_mapping()`
4. **生成测试代码** → 调用 `generate_test_code()` 使用映射中的文件名

#### 编辑项目流程
1. **前端编辑保存** → 调用 `update_automation_project()`
2. **更新项目记录** → 更新 `automation_projects` 表
3. **更新文件映射** → 调用 `file_manager.update_project_file_mapping()`
4. **更新测试代码** → 调用 `update_test_code()` 使用映射中的文件名

#### 代码管理流程
1. **获取代码** → `get_project_code()` 使用文件管理器获取文件内容
2. **保存代码** → `save_project_code()` 使用文件管理器保存到正确文件
3. **执行测试** → `run_test_in_background()` 使用文件管理器查找正确文件

### 4. 文件管理器功能

#### 核心方法
- `create_project_file_mapping()`: 创建项目文件映射
- `get_project_file_mapping()`: 获取项目文件映射
- `update_project_file_mapping()`: 更新项目文件映射
- `save_file_content()`: 保存文件内容
- `get_file_content()`: 获取文件内容
- `_generate_unique_filename()`: 生成唯一文件名

#### 使用示例
```python
# 创建新项目时
file_mapping = file_manager.create_project_file_mapping(
    project_id=automation_id,
    project_name=data['process_name'],
    product_ids=data['product_ids'],
    system=data['system'],
    environment=data.get('environment', 'test')
)

# 获取文件内容时
code_content, filename = file_manager.get_file_content(project_id)

# 保存文件内容时
success, file_path = file_manager.save_file_content(project_id, code_content)
```

## 优化效果

### 1. 文件命名更简洁
- **优化前**：`SC_Web_2_test.py`（使用项目ID）
- **优化后**：`SC_Web_test.py`、`SC_Web_2_test.py`、`SC_Web_3_test.py`（按顺序命名）

### 2. 映射关系更明确
- 每个项目都有明确的文件映射记录
- 可以通过项目ID准确查找对应的文件
- 支持项目名称和文件名的双向查找

### 3. 操作更一致
- 新建项目、编辑项目、代码管理都使用相同的文件映射逻辑
- 避免了文件操作的不一致性
- 提高了系统的可靠性

### 4. 扩展性更好
- 支持任意数量的项目
- 自动处理文件名冲突
- 便于后续功能扩展

## 测试验证

### 文件名生成测试
```
测试用例 1: SC + Web → SC_Web_test_2.py ✅
测试用例 2: SC + Web → SC_Web_test_2.py ✅  
测试用例 3: SC + Web → SC_Web_test_2.py ✅
测试用例 4: ABC + Mobile → ABC_Mobile_test.py ✅
```

### 现有文件验证
```
Test_Case目录中的文件:
- SC_Web_2_test.py
- SC_Web_3_test.py  
- SC_Web_test.py
- __init__.py
- baidu_test.py
- web_google_test.py
```

## 使用说明

### 前端开发
1. **新建项目**：正常使用 `saveProject()` 方法，后端会自动处理文件映射
2. **编辑项目**：正常使用编辑功能，后端会自动更新对应的文件
3. **代码管理**：点击代码管理按钮，系统会自动打开正确的文件

### 后端开发
1. **新增功能**：使用 `file_manager` 来处理文件操作
2. **文件查找**：通过 `get_project_file_mapping()` 获取文件信息
3. **文件操作**：使用 `save_file_content()` 和 `get_file_content()` 进行文件操作

### 数据库维护
1. **查看映射**：查询 `project_files` 表了解项目文件映射关系
2. **修复映射**：使用 `update_project_file_mapping()` 修复错误的映射
3. **清理映射**：使用 `delete_project_file_mapping()` 清理无效映射

## 总结

通过这次优化，我们实现了：

1. **✅ 简洁的文件命名**：使用更直观的命名方式
2. **✅ 精确的文件映射**：建立项目ID和文件名的明确关系
3. **✅ 一致的操作逻辑**：所有功能都基于统一的文件映射
4. **✅ 良好的扩展性**：支持项目数量的无限增长
5. **✅ 完善的错误处理**：提供后备机制确保系统稳定

这个优化为后续的功能扩展和维护奠定了坚实的基础。 
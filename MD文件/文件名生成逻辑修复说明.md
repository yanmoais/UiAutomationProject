# 文件名生成逻辑修复说明

## 问题描述

当新建自动化项目时，如果选择的产品ID是同一个，创建的py文件命名需要是新的文件，而不是与前面同一个项目共用一个py文件。

**期望的命名格式：**
- 第一个项目：`SC_Web_test.py`
- 第二个项目：`SC_Web_2_test.py`
- 第三个项目：`SC_Web_3_test.py`

## 问题分析

原来的代码在生成文件名时，只使用了固定的格式 `{product_id}_{system}_test.py`，没有检查文件是否已存在，导致多个项目可能使用相同的文件名，造成文件覆盖或冲突。

## 修复方案

### 1. 新增文件名生成函数

#### `generate_unique_filename(product_id, system)`
- **功能**：生成唯一的文件名，如果文件已存在则添加序号
- **逻辑**：
  1. 首先尝试基础文件名：`{product_id}_{system}_test.py`
  2. 如果文件不存在，直接返回基础文件名
  3. 如果文件存在，查找下一个可用的序号：`{product_id}_{system}_{counter}_test.py`
  4. 返回第一个不存在的文件名

#### `find_existing_test_file(product_id, system)`
- **功能**：查找实际存在的测试文件
- **逻辑**：
  1. 首先检查基础文件名
  2. 如果不存在，检查带序号的文件名
  3. 返回找到的第一个文件，如果都不存在则返回None

### 2. 修复相关函数

#### `generate_test_code(automation_id, data)`
- **修改**：使用 `generate_unique_filename()` 生成文件名
- **效果**：确保每个新项目都有唯一的文件名

#### `run_test_in_background(project_id, start_time, execution_id, current_user)`
- **修改**：使用 `find_existing_test_file()` 查找实际存在的文件
- **效果**：确保能正确找到并执行对应的测试文件

#### `get_project_code(project_id)`
- **修改**：使用 `find_existing_test_file()` 查找实际存在的文件
- **效果**：确保代码管理功能能正确读取文件

#### `save_project_code(project_id)`
- **修改**：使用 `find_existing_test_file()` 查找实际存在的文件
- **效果**：确保代码保存到正确的文件

#### `delete_automation_project(project_id)`
- **修改**：使用 `find_existing_test_file()` 查找实际存在的文件
- **效果**：确保删除项目时能正确删除对应的文件

## 测试验证

### 测试场景
1. **基础场景**：创建第一个项目，生成 `SC_Web_test.py`
2. **重复场景**：创建第二个相同产品ID的项目，生成 `SC_Web_2_test.py`
3. **不同产品ID**：创建不同产品ID的项目，生成 `SCS_Web_test.py`
4. **不同系统**：创建不同系统的项目，生成 `SC_Game_test.py`

### 测试结果
```
=== 测试generate_unique_filename函数 ===
产品ID: SC, 系统: Web -> 生成文件名: SC_Web_4_test.py
产品ID: SCS, 系统: Web -> 生成文件名: SCS_Web_test.py
产品ID: SC, 系统: Game -> 生成文件名: SC_Game_test.py

=== 测试find_existing_test_file函数 ===
产品ID: SC, 系统: Web -> 找到文件: SC_Web_test.py
产品ID: SCS, 系统: Web -> 未找到文件
产品ID: SC, 系统: Game -> 未找到文件
```

## 修复效果

### 1. 文件名唯一性
- ✅ 每个新项目都有唯一的文件名
- ✅ 自动添加序号避免冲突
- ✅ 支持无限扩展（理论上）

### 2. 文件查找准确性
- ✅ 能正确找到实际存在的文件
- ✅ 支持带序号的文件名查找
- ✅ 处理文件不存在的情况

### 3. 功能完整性
- ✅ 代码生成功能正常
- ✅ 测试执行功能正常
- ✅ 代码管理功能正常
- ✅ 项目删除功能正常

## 使用示例

### 创建项目流程
1. 用户选择产品ID "SC"，系统 "Web"
2. 系统检查 `SC_Web_test.py` 是否存在
3. 如果不存在，创建 `SC_Web_test.py`
4. 如果存在，创建 `SC_Web_2_test.py`
5. 如果 `SC_Web_2_test.py` 也存在，创建 `SC_Web_3_test.py`

### 执行测试流程
1. 系统查找项目对应的文件
2. 首先检查基础文件名
3. 如果不存在，检查带序号的文件名
4. 找到文件后执行测试

## 注意事项

1. **文件命名规则**：严格按照 `{product_id}_{system}_test.py` 格式
2. **序号规则**：从2开始递增，跳过已存在的序号
3. **特殊字符处理**：自动清理产品ID中的特殊字符
4. **向后兼容**：支持查找旧格式的文件名
5. **错误处理**：文件不存在时返回None，避免程序崩溃

## 相关文件

- `api/automation_management.py`：主要修复文件
- `Test_Case/`：测试文件存储目录
- `文件名生成逻辑修复说明.md`：本文档 